---
title: "AS-exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploration of the data

### Library load

```{r}
library(readr)
library(dplyr)
library(tidyverse)
library(lubridate)
```


### Data Load

```{r}
data.raw <- read_csv("../data-raw/incidents-responded-to-by-fire-companies.csv")
```

### Actual exploration

What are the column ?
```{r}
head(data.raw)
glimpse(data.raw)
```


Improve data format (optimisation)

```{r}
data.use <- data.raw %>% mutate(
  INCIDENT_TYPE_DESC=as.factor(INCIDENT_TYPE_DESC),
  HIGHEST_LEVEL_DESC=as.factor(HIGHEST_LEVEL_DESC),
  ACTION_TAKEN1_DESC=as.factor(ACTION_TAKEN1_DESC),
  ACTION_TAKEN2_DESC=as.factor(ACTION_TAKEN2_DESC),
  ACTION_TAKEN3_DESC=as.factor(ACTION_TAKEN3_DESC),
  PROPERTY_USE_DESC=as.factor(PROPERTY_USE_DESC),
  BOROUGH_DESC=as.factor(BOROUGH_DESC),
  PROPERTY_USE_DESC=as.factor(PROPERTY_USE_DESC)
  )
```

```{r}
firerelatedIncident <- data.raw %>% group_by(INCIDENT_TYPE_DESC) %>% summarise(n=n()) %>% filter(grepl('fire|smoke', tolower(INCIDENT_TYPE_DESC)) & !grepl('no fire', tolower(INCIDENT_TYPE_DESC))) %>% filter(n>200)
ggplot(data = firerelatedIncident, aes(x=INCIDENT_TYPE_DESC, y=n)) +geom_bar(stat="identity")
data.use <- data.use %>%  filter(INCIDENT_TYPE_DESC %in% (firerelatedIncident %>% pull(INCIDENT_TYPE_DESC)))
```

## Nb intervention par p√©riode par quartier

```{r}
# Count by borough
data.perweekday <- data.use %>% 
  group_by(BOROUGH_DESC, weekdays(INCIDENT_DATE_TIME)) %>% 
  summarize(n=n()) #%>% 
  #spread(key = BOROUGH_DESC, value = n)
data.perweeknb <- data.use %>% 
  group_by(BOROUGH_DESC, WEEK_NB = as.numeric(strftime(INCIDENT_DATE_TIME,format="%W"))) %>%
  summarize(n=n())

data.perweeknb.Years <- data.use %>% 
  group_by(YEAR = strftime(INCIDENT_DATE_TIME,format="%Y"), WEEK_NB = as.numeric(strftime(INCIDENT_DATE_TIME,format="%W"))) %>% 
  summarize(n=n()) %>%
  ungroup() %>% 
  filter(YEAR!=2018) %>% 
  group_by(WEEK_NB) %>%
  summarise(VAR=sqrt(var(n)))
```

```{r}
ggplot(
  data=data.perweeknb,
  aes(x=WEEK_NB, y=n, color = BOROUGH_DESC, linetype = BOROUGH_DESC)
  ) +
  geom_point() +
  geom_line()
ggplot(
  data=data.perweekday %>% mutate(ID=row_number()),
  aes(x=ID, y=n, color = BOROUGH_DESC, linetype = BOROUGH_DESC)
  ) +
  geom_point() +
  geom_line()
ggplot(
    data=data.perweeknb.Years,
    aes(x=WEEK_NB, y=VAR)
  ) +
  geom_point() +
  geom_line()
```

## Mean ncident duration per period / week day

```{r}
# Mean by borough
data.time.perweekday <- data.use %>% 
  filter(!is.na(TOTAL_INCIDENT_DURATION)) %>% 
  group_by(BOROUGH_DESC, weekdays(INCIDENT_DATE_TIME)) %>% 
  summarize(MEAN_TIME=mean(TOTAL_INCIDENT_DURATION)) %>% 
  filter(MEAN_TIME<10000)

data.time.perweeknb <- data.use %>%
  filter(!is.na(TOTAL_INCIDENT_DURATION)) %>%
  group_by(BOROUGH_DESC, WEEK_NB = as.numeric(strftime(INCIDENT_DATE_TIME,format="%W"))) %>% 
  summarize(MEAN_TIME=mean(TOTAL_INCIDENT_DURATION)) %>% 
  filter(MEAN_TIME<10000)
```

```{r}
ggplot(
  data=data.time.perweeknb,
  aes(x=WEEK_NB, y=MEAN_TIME, color = BOROUGH_DESC, linetype = BOROUGH_DESC)
  ) +
  geom_point() +
  geom_line()
ggplot(
  data=data.time.perweekday %>% mutate(ID=row_number()),
  aes(x=ID, y=MEAN_TIME, color = BOROUGH_DESC, linetype = BOROUGH_DESC)
  ) +
  geom_point() +
  geom_line()
```
### Year Compartison

```{r}
data.time.year.perweeknb.var <- data.use %>%
  filter(!is.na(TOTAL_INCIDENT_DURATION)) %>%
  group_by(YEAR = strftime(INCIDENT_DATE_TIME,format="%Y"), WEEK_NB = as.numeric(strftime(INCIDENT_DATE_TIME,format="%W"))) %>% 
  summarize(MEAN_TIME=mean(TOTAL_INCIDENT_DURATION)) %>% 
  filter(MEAN_TIME<10000) %>% 
  ungroup() %>% 
  filter(YEAR!=2018) %>% 
  group_by(WEEK_NB) %>%
  summarise(VAR=sqrt(var(MEAN_TIME)))
```

```{r}
ggplot(
  data=data.time.year.perweeknb.var,
  aes(x=WEEK_NB, y=VAR)
  ) +
  geom_point() +
  geom_line()
```


## Mean number of cars

```{r}
# Count by borough
data.perweekday.units <- data.use %>% 
  filter(!is.na(UNITS_ONSCENE)) %>% 
  group_by(BOROUGH_DESC, weekdays(INCIDENT_DATE_TIME)) %>% 
  summarize(n=mean(UNITS_ONSCENE))

data.perweeknb.units <- data.use %>% 
  filter(!is.na(UNITS_ONSCENE)) %>% 
  group_by(BOROUGH_DESC, WEEK_NB = as.numeric(strftime(INCIDENT_DATE_TIME,format="%W"))) %>%
  summarize(n=mean(UNITS_ONSCENE))
```

# Per day analysis

```{r}
data.perweekday <- data.use %>%
  group_by(YEAR = strftime(INCIDENT_DATE_TIME,format="%Y"), DAY_DATE = strftime(INCIDENT_DATE_TIME,format="%m-%d")) %>% 
  summarize(n=n()) %>%
  mutate(DAY = row_number())
ggplot(
  data=data.perweekday,
  aes(x=DAY, y=n, color = YEAR, linetype = YEAR)
  ) +
  geom_point() +
  geom_line()
data.perweekday %>% filter(n>250)
```

